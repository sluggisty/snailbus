# Snailbus

![Snailbus Logo](snailbus.png)
![Tests](https://github.com/sluggisty/snailbus/workflows/Tests/badge.svg)
[![codecov](https://codecov.io/gh/sluggisty/snailbus/branch/main/graph/badge.svg)](https://codecov.io/gh/sluggisty/snailbus)

Backend service to display system information uploaded by snail-core.

## Overview

Snailbus is a lightweight Go webserver built with Gin that provides a REST API for receiving and displaying system information collected by snail-core. It serves as the central hub for aggregating and managing system diagnostics from multiple hosts.

## Quick Start

### Using Docker Compose (Recommended)

```bash
# Build and start the service (includes PostgreSQL)

docker-compose up -d

# View logs
docker-compose logs -f

# Stop the service
docker-compose down

# Stop and remove volumes (clears database)
docker-compose down -v
```

The service will be available at `http://localhost:8080`

### Local Development

**Prerequisites:**
- PostgreSQL 16+ running locally
- Go 1.24 or later

```bash
# Install dependencies
go mod download

# Set database URL (or use default)
export DATABASE_URL="postgres://snail:snail_secret@localhost:5432/snailbus?sslmode=disable"

# Run the server (migrations run automatically on startup)
go run main.go
```

## Database

Snailbus uses PostgreSQL for persistent storage. Database migrations are automatically run on application startup using [golang-migrate](https://github.com/golang-migrate/migrate).

### Migration Files

Migrations are located in the `migrations/` directory:
- `000001_initial_schema.up.sql` - Creates the initial database schema
- `000001_initial_schema.down.sql` - Drops the schema (for rollback)

### Database Schema

The initial schema includes:

- **hosts** table: Stores system information from snail-core agents
  - `host_id` (UUID, PRIMARY KEY): Unique persistent identifier for each host
  - `hostname` (TEXT): Hostname of the system (not unique - multiple hosts can have the same hostname)
  - `received_at` (TIMESTAMPTZ): When the data was received
  - `collection_id` (TEXT): Collection identifier
  - `timestamp` (TEXT): Original timestamp from snail-core
  - `snail_version` (TEXT): Version of snail-core that collected the data
  - `data` (JSONB): Full system information data
  - `errors` (TEXT[]): Any errors encountered during collection

### Manual Migration Management

If you need to manage migrations manually:

```bash
# Install golang-migrate CLI
go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest

# Create a new migration
migrate create -ext sql -dir migrations -seq add_new_table

# Run migrations up
migrate -path migrations -database "postgres://snail:snail_secret@localhost:5432/snailbus?sslmode=disable" up

# Rollback one migration
migrate -path migrations -database "postgres://snail:snail_secret@localhost:5432/snailbus?sslmode=disable" down 1
```
# Run the server
go run main.go
```

## OpenAPI Specification

Snailbus provides a complete OpenAPI 3.0 specification for all API endpoints. The specification is **automatically generated from code annotations** using [swaggo/swag](https://github.com/swaggo/swag), ensuring it always stays in sync with the actual API implementation.

### Accessing the OpenAPI Spec

- **Swagger UI**: `GET /swagger/index.html` - Interactive API documentation
- **JSON format**: `GET /openapi.json` - OpenAPI spec in JSON
- **YAML format**: `GET /openapi.yaml` - OpenAPI spec in YAML

The generated specification files are located in the `docs/` directory (generated by swag).

### Generating the Spec from Code

The OpenAPI specification is generated directly from code annotations in the handlers. To regenerate it:

```bash
# Generate OpenAPI spec from code annotations
make swag

# Or use the command directly
swag init -g main.go -o docs --parseDependency --parseInternal
```

**Note**: You need to install swag first:
```bash
go install github.com/swaggo/swag/cmd/swag@latest
```

The spec is automatically generated from:
- **Handler annotations**: Each handler function has `@Summary`, `@Description`, `@Tags`, `@Param`, `@Success`, `@Failure`, and `@Router` annotations
- **Model annotations**: Data models have `@Description` annotations
- **General API info**: Defined in `main.go` with `@title`, `@version`, `@description`, etc.

### Viewing the API Documentation

- **Swagger UI**: Visit `http://localhost:8080/swagger/index.html` when the server is running
- **Redoc**: Import the generated `docs/swagger.yaml` or `docs/swagger.json`
- **Postman**: Import the OpenAPI spec to generate a Postman collection

## API Endpoints

### Health Check
```
GET /health
```

Returns:
```json
{
  "status": "ok",
  "service": "snailbus",
  "database": "connected"
}
```

### Root
```
GET /
```

Returns:
```json
{
  "message": "Welcome to Snailbus API",
  "version": "1.0.0"
}
```

### Ingest (Receive Data from snail-core)
```
POST /api/v1/ingest
Content-Type: application/json
Content-Encoding: gzip (optional)
```

Accepts data from snail-core agents. Supports both compressed (gzip) and uncompressed JSON payloads.

**Request Body:**
```json
{
  "meta": {
    "hostname": "example-host",
    "collection_id": "uuid-here",
    "timestamp": "2024-01-01T00:00:00Z",
    "snail_version": "0.2.0"
  },
  "data": {
    "system": { ... },
    "hardware": { ... },
    "packages": { ... }
  },
  "errors": []
}
```

**Response (201 Created):**
```json
{
  "status": "ok",
  "report_id": "example-host",
  "received_at": "2024-01-01T00:00:00Z",
  "message": "Host data updated successfully"
}
```

### List Hosts
```
GET /api/v1/hosts
```

Returns a list of all known hosts.

**Response:**
```json
{
  "hosts": [
    {
      "hostname": "example-host",
      "last_seen": "2024-01-01T00:00:00Z"
    }
  ],
  "total": 1
}
```

### Get Host
```
GET /api/v1/hosts/:hostname
```

Returns the full report data for a specific host.

**Response:**
```json
{
  "id": "example-host",
  "received_at": "2024-01-01T00:00:00Z",
  "meta": {
    "hostname": "example-host",
    "collection_id": "uuid-here",
    "timestamp": "2024-01-01T00:00:00Z",
    "snail_version": "0.2.0"
  },
  "data": { ... },
  "errors": []
}
```

### Delete Host
```
DELETE /api/v1/hosts/:hostname
```

Removes a host and all its data from the database.

**Response:** 204 No Content

## Development

### Prerequisites

- Go 1.24 or later
- PostgreSQL 16+ (or use Docker Compose)
- Docker and Docker Compose (for containerized deployment)

### Building

```bash
# Build binary
go build -o snailbus main.go

# Or use Makefile
make build

# Run binary
./snailbus

# Or use Makefile
make run
```

### OpenAPI Tools

The OpenAPI specification is generated from code annotations using `swag`:

```bash
# Generate OpenAPI spec from code annotations
make swag

# Or use the alias
make generate-spec

# Validate OpenAPI spec
make validate
```

### Docker Build

```bash
# Build Docker image
docker build -t snailbus .

# Run container (requires PostgreSQL)
docker run -p 8080:8080 \
  -e DATABASE_URL="postgres://snail:snail_secret@host.docker.internal:5432/snailbus?sslmode=disable" \
  snailbus
```

## Project Structure

```
snailbus/
├── main.go              # Main application entry point
├── go.mod              # Go module definition
├── go.sum              # Go module checksums
├── Dockerfile          # Docker build configuration
├── docker-compose.yml  # Docker Compose configuration
├── Makefile            # Build and development commands
├── migrations/         # Database migration files
│   ├── 000001_initial_schema.up.sql
│   └── 000001_initial_schema.down.sql
├── cmd/                # Command-line tools
│   └── create-admin/   # Admin user creation tool
├── internal/            # Internal packages
│   ├── handlers/       # HTTP request handlers
│   ├── models/         # Data models
│   └── storage/        # Database storage interface and implementation
├── snailbus.png        # Project logo
└── README.md           # This file
```

## Configuration

### Environment Variables

- `DATABASE_URL`: PostgreSQL connection string (required)
  - Default: `postgres://snail:snail_secret@localhost:5432/snailbus?sslmode=disable`
  - Format: `postgres://user:password@host:port/database?sslmode=disable`
  
- `MIGRATIONS_PATH`: Path to migration files
  - Default: `file://migrations`
  
- `PORT`: Main API server port
  - Default: `8080`
  
- `METRICS_PORT`: Prometheus metrics server port
  - Default: `9090`
  - The metrics server runs on a separate port for network-level security
  
- `METRICS_BIND_ADDRESS`: IP address to bind the metrics server to
  - Default: `127.0.0.1` (localhost only)
  - Set to `0.0.0.0` to allow access from other hosts (use with firewall rules)
  - **Security Note**: Keep metrics on localhost in production and use network-level restrictions (firewall, reverse proxy) to control access
  
- `GIN_MODE`: Gin framework mode
  - `debug`: Development mode with detailed logging (default)
  - `release`: Production mode with optimized performance

- `RATE_LIMIT_GENERAL`: Rate limit for general authenticated API endpoints per API key
  - Default: `100-M` (100 requests per minute)
  - Format: `{number}-{period}` where period can be `S`, `M`, `H` (second, minute, hour)

- `RATE_LIMIT_REGISTER`: Rate limit for `/auth/register` endpoint per IP address
  - Default: `10-M` (10 requests per minute)
  - Format: `{number}-{period}` where period can be `S`, `M`, `H` (second, minute, hour)

- `RATE_LIMIT_LOGIN`: Rate limit for `/auth/login` and `/auth/api-key` endpoints per IP address
  - Default: `20-M` (20 requests per minute)
  - Format: `{number}-{period}` where period can be `S`, `M`, `H` (second, minute, hour)

- `RATE_LIMIT_INGEST`: Rate limit for `/ingest` endpoint per API key
  - Default: `50-M` (50 requests per minute)
  - Format: `{number}-{period}` where period can be `S`, `M`, `H` (second, minute, hour)

- `MAX_REQUEST_SIZE_INGEST`: Maximum request size for `/ingest` endpoint
  - Default: `10MB`
  - Format: `{number}{unit}` where unit can be `KB`, `MB`, `GB`

- `MAX_REQUEST_SIZE_POST`: Maximum request size for POST/PUT/PATCH endpoints (except `/ingest`)
  - Default: `1MB`
  - Format: `{number}{unit}` where unit can be `KB`, `MB`, `GB`

- `MAX_REQUEST_SIZE_GET`: Maximum request size for GET endpoints
  - Default: `100KB`
  - Format: `{number}{unit}` where unit can be `KB`, `MB`, `GB`

## Configuration Validation

The application validates all configuration on startup and fails fast with clear error messages if validation fails.

### Command Line Options

- `--validate-config`: Validate configuration and exit without starting the server
  - Useful for CI/CD pipelines and configuration testing
  - Returns exit code 0 on success, 1 on validation failure

### Configuration Requirements

- **DATABASE_URL**: Must be a valid PostgreSQL connection string (tested with actual connection)
- **PORT/METRICS_PORT**: Must be valid port numbers (1-65535)
- **LOG_LEVEL**: Must be one of: `trace`, `debug`, `info`, `warn`, `error`, `fatal`, `panic`
- **GIN_MODE**: Must be one of: `debug`, `release`, `test`
- **CSRF_AUTH_KEY**: If provided, must be valid base64 encoding 32 bytes when decoded
- **Rate limit formats**: Must follow `{number}-{period}` format where period is `S`, `M`, or `H`

- `CONTENT_SECURITY_POLICY`: Content Security Policy header value
  - Default: `default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self'; frame-ancestors 'none';`
  - Controls which resources can be loaded and executed on the page
  - Customize for your specific frontend requirements

- `CSRF_AUTH_KEY`: Base64-encoded 32-byte key for CSRF token validation
  - Default: Randomly generated on startup (logged to console)
  - Set this in production for consistent CSRF token validation across restarts
  - Generate with: `openssl rand -base64 32`

### Docker Compose Configuration

The `docker-compose.yml` includes:
- **snailbus**: The main application service
- **postgres**: PostgreSQL 16 database service
- **postgres_data**: Persistent volume for database data

Default database credentials:
- User: `snail`
- Password: `snail_secret`
- Database: `snailbus`

**⚠️ Change these credentials in production!**

## Architecture

Snailbus is designed to be the central collection point for system information gathered by snail-core agents running on various Linux hosts. The service:

1. Receives diagnostic data from snail-core agents
2. Stores data in PostgreSQL with automatic schema migrations
3. Provides REST API endpoints for querying and displaying system information
4. Monitors database health and connection status

## License

MIT

## Contributing

Contributions are welcome! Please feel free to submit a Pull Request.
